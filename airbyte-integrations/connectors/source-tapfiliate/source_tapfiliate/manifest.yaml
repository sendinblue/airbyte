version: "0.29.0"

definitions:
  schema_loader:
    type: JsonFileSchemaLoader
    file_path: "./source_tapfiliate/schemas/{{ parameters['name'] }}.json"
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []
  requester:
    type: HttpRequester
    url_base: "https://api.tapfiliate.com/1.6"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      api_token: '{{ config[''api_key''] }}'
      inject_into:
        type: RequestOption
        inject_into: header
        field_name: X-Api-Key
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      page_token_option:
        type: RequestOption
        inject_into: request_parameter
        field_name: page
      pagination_strategy:
        type: PageIncrement
        start_from_page: 1
        inject_on_first_request: true
  pagination_incremental_sync:
    type: DatetimeBasedCursor
    cursor_field: created_at
    cursor_datetime_formats:
      - '%Y-%m-%dT%H:%M:%S+00:00'
    datetime_format: '%Y-%m-%dT%H:%M:%S+00:00'
    start_datetime:
      type: MinMaxDatetime
      datetime: '{{ config[''start_date''] }}'
      datetime_format: '%Y-%m-%dT%H:%M:%SZ'
  incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: created_at
      start_datetime:
        type: MinMaxDatetime
        datetime: '{{ config[''start_date''] }}'
        datetime_format: '%Y-%m-%dT%H:%M:%SZ'
      datetime_format: '%Y-%m-%d'
      start_time_option:
        type: RequestOption
        field_name: date_from
        inject_into: request_parameter
      cursor_datetime_formats:
        - '%Y-%m-%dT%H:%M:%S+00:00'

streams:
  - type: DeclarativeStream
    $parameters:
      name: "customers"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/customers"
    incremental_sync:
      $ref: "#/definitions/incremental_sync"
  - type: DeclarativeStream
    $parameters:
      name: "conversions"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/conversions"
    incremental_sync:
      $ref: "#/definitions/incremental_sync"
  - type: DeclarativeStream
    $parameters:
      name: "programs"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/programs"
  - type: DeclarativeStream
    $parameters:
      name: "affiliates"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/affiliates"
  - type: DeclarativeStream
    $parameters:
      name: "commissions"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/commissions"
    incremental_sync:
      $ref: "#/definitions/pagination_incremental_sync"
  - type: DeclarativeStream
    $parameters:
      name: "affiliate-groups"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/affiliate-groups"
  - type: DeclarativeStream
    $parameters:
      name: "affiliate-prospects"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/affiliate-prospects"
check:
  type: CheckStream
  stream_names:
    - "customers"
    - "conversions"
    - "programs"
    - "commissions"
    - "affiliates"
    - "affiliate-groups"
    - "affiliate-prospects"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/tapfiliate
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    type: object
    required:
      - start_date
      - api_key
    properties:
      start_date:
        type: string
        title: Start date
        format: date-time
        pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$
        order: 0
      api_key:
        type: string
        title: API Key
        airbyte_secret: true
        order: 1
    additionalProperties: true
